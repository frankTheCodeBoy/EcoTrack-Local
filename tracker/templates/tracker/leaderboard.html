{% extends 'tracker/base.html' %}
{% load static %}
{% block head %}
  <link rel="stylesheet" href="{% static 'css/leaderboard.css' %}">
  <style>
    /* Avatar zoom effect */
    .lb-avatar {
      transition: transform 0.2s ease;
      cursor: pointer;
    }
    .lb-avatar:hover,
    .lb-avatar:active {
      transform: scale(1.1);
    }

    /* Modal styles */
    .modal-avatar {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }
  </style>
{% endblock %}
{% block title %}Leaderboard{% endblock %}
{% block content %}
  <h2 class="mb-4">üèÜ EcoTrack Leaderboard</h2>
  <p class="text-muted">Top contributors ranked by total eco points.</p>
  {% if top_profiles %}
    <table class="table table-striped table-bordered shadow-sm">
      <thead class="table-success">
        <tr>
          <th scope="col">Rank</th>
          <th scope="col">Avatar</th>
          <th scope="col">Username</th>
          <th scope="col">Badge</th>
          <th scope="col">Total Points</th>
        </tr>
      </thead>
      <tbody>
        {% for profile in top_profiles %}
          <tr>
            <td>
              {% if forloop.counter == 1 %}ü•á
              {% elif forloop.counter == 2 %}ü•à
              {% elif forloop.counter == 3 %}ü•â
              {% else %}{{ forloop.counter }}<sup>th</sup>
              {% endif %}
            </td>
            <td>
              <img src="{% if profile.avatar and profile.avatar.name %}{{ profile.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
                   alt="Avatar"
                   class="rounded-circle border lb-avatar"
                   style="width:40px; height:40px; object-fit:cover;"
                   data-bs-toggle="modal"
                   data-bs-target="#avatarModal"
                   data-username="{{ profile.user.username }}"
                   data-badge="{{ profile.badge_level }}"
                   data-points="{{ profile.total_points }}"
                   data-avatar="{% if profile.avatar and profile.avatar.name %}{{ profile.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}">
            </td>
            <td>
              <a href="{% url 'profile' %}?user={{ profile.user.username }}">
                {{ profile.user.username }}
              </a>
            </td>
            <td>{{ profile.badge_level }}</td>
            <td>
              <strong title="Eco actions logged and verified">
                {{ profile.total_points }}
              </strong>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-warning">No users have logged actions yet.</div>
  {% endif %}

  <div class="mt-4">
    <a href="{% url 'dashboard' %}" class="btn btn-outline-success">
      ‚Üê Back to Dashboard
    </a>
    <a href="{% url 'region_summary' %}" class="btn btn-outline-dark">
      üìç View Regional Summary
    </a>
  </div>

  <!-- Modal Preview -->
  <div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="avatarModalLabel">Contributor Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalAvatar" src="" alt="Avatar" class="rounded-circle modal-avatar mb-3">
          <h5 id="modalUsername"></h5>
          <p class="mb-1"><strong>Badge:</strong> <span id="modalBadge"></span></p>
          <p><strong>Total Points:</strong> <span id="modalPoints"></span></p>
          <a id="modalProfileLink" href="#" class="btn btn-outline-primary">View Full Profile</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  const avatarModal = document.getElementById('avatarModal');
  avatarModal.addEventListener('show.bs.modal', function (event) {
    const trigger = event.relatedTarget;
    const avatar = trigger.getAttribute('data-avatar');
    const username = trigger.getAttribute('data-username');
    const badge = trigger.getAttribute('data-badge');
    const points = trigger.getAttribute('data-points');

    document.getElementById('modalAvatar').src = avatar;
    document.getElementById('modalUsername').textContent = username;
    document.getElementById('modalBadge').textContent = badge;
    document.getElementById('modalPoints').textContent = points;
    document.getElementById('modalProfileLink').href = `/profile/?user=${username}`;
  });
</script>
{% endblock %}
